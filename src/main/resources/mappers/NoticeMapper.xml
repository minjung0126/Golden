<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goldenage.project.notice.model.dao.NoticeMapper">

    <resultMap id="noticeResultMap" type="NoticeDTO">
        <id property="noticeNo" column="NOTICE_NO"/>
        <result property="noticeName" column="NOTICE_NAME"/>
        <result property="noticeContent" column="NOTICE_CONTENT"/>
        <result property="noticeRegistDate" column="NOTICE_REGIST_DATE"/>
        <result property="noticeModifyDate" column="NOTICE_MODIFY_DATE"/>
        <result property="noticeLink" column="NOTICE_LINK"/>
        <result property="noticeCount" column="NOTICE_COUNT"/>
        <collection property="noticeFile" ofType="NoticeFileDTO">
            <result property="noticeNo" column="NOTICE_NO"/>
            <result property="noticeFileNum" column="NOTICE_FILE_NUM"/>
            <result property="noticeOriName" column="NOTICE_ORI_NAME"/>
            <result property="noticeFileName" column="NOTICE_FILE_NAME"/>
            <result property="savedPath" column="SAVED_PATH"/>
        </collection>
    </resultMap>

    <select id="selectNoticeList" resultMap="noticeResultMap">
        SELECT
        *
        FROM (SELECT
                     @RNUM := @RNUM + 1 AS ROWNUM
                   , N.NOTICE_NO
                   , N.NOTICE_NAME
                   , N.NOTICE_REGIST_DATE
                FROM NOTICE N
                ,(SELECT @RNUM:=0)AS R
               WHERE 1=1
               ORDER BY N.NOTICE_NO DESC
        )list
       WHERE  ROWNUM >= #{ startRow } AND
        <![CDATA[
         ROWNUM <= #{ endRow }
        ]]>
        ORDER BY 1 ASC
    </select>

    <select id="selectNoticeDetail" resultMap="noticeResultMap" parameterType="_int">
       SELECT
              N.NOTICE_NO
            , N.NOTICE_NAME
            , N.NOTICE_CONTENT
            , N.NOTICE_LINK
            , N.NOTICE_COUNT
            , NF.NOTICE_ORI_NAME
         FROM NOTICE N
         JOIN NOTICE_FILE NF ON (N.NOTICE_NO = NF.NOTICE_NO)
        WHERE N.NOTICE_NO = #{ noticeNo }
    </select>

    <select id="selectTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
               COUNT(*)
          FROM NOTICE
         ORDER BY NOTICE_NO DESC
    </select>

    <update id="incrementNoticeCount">
        UPDATE
               NOTICE
           SET NOTICE_COUNT = (SELECT
                                      C.NOTICE_COUNT
                                 FROM (SELECT
                                              B.NOTICE_COUNT
                                         FROM NOTICE B
                                        WHERE B.NOTICE_NO = #{ noticeNo }
                                      ) AS C
                              ) +1
        WHERE NOTICE_NO = #{ noticeNo }
    </update>

    <insert id="noticeInsert">
        INSERT
          INTO NOTICE
        (
          NOTICE_NO
        , NOTICE_NAME
        , NOTICE_CONTENT
        , NOTICE_REGIST_DATE
        , NOTICE_MODIFY_DATE
        , NOTICE_LINK
        )
        VALUES
        (
          NOTICE_NO
        , #{ noticeName }
        , #{ noticeContent }
        , DATE_FORMAT(now(), '%Y%m%d%H%i%s')
        , NULL
        , #{ noticeLink }
        )
    </insert>
</mapper>